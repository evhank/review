<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>energiavital - Produkttext Review</title>
    <style>
        /* ============================================
           REVIEW INTERFACE - MAIN STYLES
           ============================================ */
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #333;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #a0ba32 0%, #8ca329 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .product-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .product-name {
            font-weight: 600;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-sku {
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .ampel {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .ampel.GR√úN { background: #22c55e; color: white; }
        .ampel.GELB { background: #eab308; color: #1a1a2e; }
        .ampel.ROT { background: #ef4444; color: white; }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .queue-info {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 0;
            height: calc(100vh - 56px);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 120px; /* Mehr Platz f√ºr fixierte Action Bar */
        }
        
        .panel {
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .panel:last-child {
            border-right: none;
        }
        
        .panel-header {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        
        /* Old Text Panel - auch mit energiavital CSS */
        .old-text-content {
            font-size: 13px;
            line-height: 1.6;
            color: #333;
        }
        
        .old-text-content:empty::before {
            content: "Kein alter Text vorhanden";
            color: #999;
            font-style: italic;
        }
        
        /* energiavital CSS auch f√ºr alten Text */
        .old-text-content {
            --ev-primary: #a0ba32;
            --ev-primary-light: #cde07a;
            --ev-bg-warm: #f2ebe3;
            --ev-bg-light: #f9f6f1;
            --ev-bg-white: #ffffff;
            --ev-text: #333333;
            --ev-shadow: -2px 2px 8px rgba(0, 0, 0, 0.1);
            --ev-radius-box: 10px;
            --ev-radius-button: 12px;
        }
        
        .old-text-content .info-box,
        .old-text-content .ideal-box,
        .old-text-content .quality-box,
        .old-text-content .dosage-box,
        .old-text-content .ingredients-box {
            padding: 12px;
            border-radius: var(--ev-radius-box);
            margin: 15px 0;
            box-shadow: var(--ev-shadow);
        }
        
        .old-text-content .info-box { background-color: var(--ev-bg-warm); }
        .old-text-content .ideal-box,
        .old-text-content .quality-box,
        .old-text-content .dosage-box { background-color: var(--ev-bg-light); }
        
        .old-text-content .badge {
            background-color: var(--ev-primary-light);
            padding: 5px 10px;
            margin: 3px;
            border-radius: var(--ev-radius-button);
            display: inline-block;
            font-weight: bold;
            font-size: 11px;
        }
        
        .old-text-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin: 10px 0;
        }
        
        .old-text-content th, .old-text-content td {
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        
        .old-text-content th {
            background: var(--ev-bg-light);
        }
        
        /* Preview Panel */
        .preview-panel .panel-content {
            background: #fafafa;
        }
        
        .device-toggle {
            display: flex;
            gap: 4px;
            background: #e0e0e0;
            padding: 2px;
            border-radius: 4px;
        }
        
        .device-toggle button {
            background: transparent;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .device-toggle button.active {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .preview-frame {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            margin: 0 auto;
        }
        
        .preview-frame.desktop { max-width: 100%; }
        .preview-frame.tablet { max-width: 768px; }
        .preview-frame.mobile { max-width: 375px; }
        
        .preview-content {
            padding: 20px;
        }
        
        /* Protocol Panel */
        .protocol-section {
            margin-bottom: 20px;
        }
        
        .protocol-section-title {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .protocol-section-title .status-icon {
            font-size: 1.2em;
        }
        
        .protocol-item {
            background: #f9f9f9;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .protocol-item.success { border-left: 3px solid #22c55e; }
        .protocol-item.warning { border-left: 3px solid #eab308; }
        .protocol-item.error { border-left: 3px solid #ef4444; }
        
        .claim-list {
            margin-top: 8px;
        }
        
        .claim-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .claim-item:last-child {
            border-bottom: none;
        }
        
        .claim-status {
            flex-shrink: 0;
        }
        
        .faq-item {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .faq-question {
            font-weight: 600;
            font-size: 12px;
            color: #2563eb;
            margin-bottom: 6px;
        }
        
        .faq-answer {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
        }
        
        .seo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .seo-item {
            background: #f5f5f5;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .seo-item .label {
            color: #999;
            display: block;
            margin-bottom: 2px;
        }
        
        .seo-item .value {
            font-weight: 600;
        }
        
        .seo-item .value.ok { color: #22c55e; }
        .seo-item .value.warning { color: #eab308; }
        
        /* Action Bar - fixiert am unteren Rand */
        .action-bar {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn.approve {
            background: #22c55e;
            color: white;
        }
        
        .action-btn.approve:hover:not(:disabled) {
            background: #16a34a;
        }
        
        .action-btn.reject {
            background: #ef4444;
            color: white;
        }
        
        .action-btn.reject:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .action-btn.revise {
            background: #f59e0b;
            color: white;
        }
        
        .action-btn.revise:hover:not(:disabled) {
            background: #d97706;
        }
        
        .comment-section {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .comment-section input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .comment-section input:focus {
            outline: none;
            border-color: #a0ba32;
            box-shadow: 0 0 0 3px rgba(160,186,50,0.1);
        }
        
        .reviewer-select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        
        /* Loading & Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26,26,46,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #a0ba32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-state {
            text-align: center;
            padding: 60px;
        }
        
        .error-state h2 {
            color: #ef4444;
            margin-bottom: 10px;
        }
        
        .setup-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a2e;
        }
        
        .setup-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .setup-card h1 {
            color: #a0ba32;
            margin-bottom: 10px;
        }
        
        .setup-card p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .setup-card label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        
        .setup-card input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .setup-card button {
            width: 100%;
            padding: 14px;
            background: #a0ba32;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .setup-card button:hover {
            background: #8ca329;
        }
        
        .setup-card .hint {
            font-size: 12px;
            color: #999;
            margin-top: -10px;
            margin-bottom: 16px;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            right: 24px;
            padding: 14px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ============================================
           ENERGIAVITAL PRODUKTSEITEN CSS
           ============================================ */
        
        .preview-content {
            --ev-primary: #a0ba32;
            --ev-primary-light: #cde07a;
            --ev-bg-warm: #f2ebe3;
            --ev-bg-light: #f9f6f1;
            --ev-bg-white: #ffffff;
            --ev-text: #333333;
            --ev-text-muted: #666666;
            --ev-shadow: -2px 2px 8px rgba(0, 0, 0, 0.1);
            --ev-radius-box: 10px;
            --ev-radius-button: 12px;
        }
        
        .preview-content .info-box,
        .preview-content .ideal-box,
        .preview-content .quality-box,
        .preview-content .dosage-box,
        .preview-content .ingredients-box {
            padding: 15px;
            border: none;
            border-radius: var(--ev-radius-box);
            margin: 20px 0;
            text-align: left;
            box-shadow: var(--ev-shadow);
        }
        
        .preview-content .info-box { background-color: var(--ev-bg-warm); }
        .preview-content .ideal-box,
        .preview-content .quality-box,
        .preview-content .dosage-box,
        .preview-content .ingredients-box { background-color: var(--ev-bg-light); }
        
        .preview-content .info-button,
        .preview-content .ideal-button,
        .preview-content .quality-icon,
        .preview-content .dosage-icon,
        .preview-content .accordion-icon {
            background-color: var(--ev-primary);
            color: white;
            padding: 2px 8px;
            border-radius: var(--ev-radius-button);
            font-size: small;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }
        
        .preview-content .badge {
            background-color: var(--ev-primary-light);
            color: var(--ev-text);
            padding: 8px 13px;
            margin: 5px;
            border-radius: var(--ev-radius-button);
            display: inline-block;
            font-weight: bold;
        }
        
        .preview-content .ideal-box ul {
            list-style-type: disc;
            padding-left: 18px;
            margin: 0;
        }
        
        .preview-content .ideal-box ul li {
            color: var(--ev-text);
            line-height: 1.4;
            margin-bottom: 6px;
        }
        
        .preview-content .ideal-box ul li::marker {
            color: var(--ev-primary);
        }
        
        .preview-content .product-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--ev-shadow);
            margin: 25px 0;
            background: white;
        }
        
        .preview-content .product-table th {
            background: var(--ev-bg-light);
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
            font-size: 13px;
        }
        
        .preview-content .product-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .preview-content .table-footnote {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
        }
        
        .preview-content .accordion-section summary { list-style: none; }
        .preview-content .accordion-section summary::-webkit-details-marker { display: none; }
        
        .preview-content .accordion-button {
            width: 100%;
            background: var(--ev-bg-light);
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border-radius: var(--ev-radius-box);
            box-shadow: var(--ev-shadow);
        }
        
        .preview-content .accordion-button-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-content .accordion-arrow {
            font-size: 24px;
            color: var(--ev-primary);
            transition: transform 0.3s;
        }
        
        .preview-content details[open] .accordion-arrow {
            transform: rotate(180deg);
        }
        
        .preview-content .accordion-content-inner {
            padding: 20px;
            background: white;
            border-radius: 0 0 var(--ev-radius-box) var(--ev-radius-box);
            margin-top: -10px;
        }
        
        .preview-content .legal-notice {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }
        
        .preview-content .allergen-section {
            padding: 12px 15px;
            background: #fff8e6;
            border-left: 3px solid #e6a800;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
        }
        
        .preview-content .nowrap { white-space: nowrap; }
        
        /* Mobile Preview */
        .preview-frame.mobile .preview-content .product-table { display: block; box-shadow: none; background: transparent; }
        .preview-frame.mobile .preview-content .product-table thead { display: none; }
        .preview-frame.mobile .preview-content .product-table tbody { display: block; }
        .preview-frame.mobile .preview-content .product-table tr {
            display: block;
            background: white;
            border-radius: 10px;
            box-shadow: var(--ev-shadow);
            margin-bottom: 15px;
            overflow: hidden;
        }
        .preview-frame.mobile .preview-content .product-table td {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            width: 100%;
        }
        .preview-frame.mobile .preview-content .product-table td:first-child {
            display: block;
            font-weight: bold;
            background: var(--ev-bg-light);
            border-bottom: 3px solid var(--ev-primary);
        }
        .preview-frame.mobile .preview-content .product-table td:nth-child(2)::before { content: "pro Kapsel:"; color: #666; margin-right: 10px; }
        .preview-frame.mobile .preview-content .product-table td:nth-child(3)::before { content: "pro Tagesdosis:"; color: #666; margin-right: 10px; }
        .preview-frame.mobile .preview-content .product-table td:nth-child(4)::before { content: "in %*:"; color: #666; margin-right: 10px; }
        .preview-frame.mobile .preview-content .product-table td:nth-child(5)::before { content: "pro 100 g:"; color: #666; margin-right: 10px; }
    </style>
</head>
<body>
    <!-- Setup Screen (wenn kein Token) -->
    <div id="setupScreen" class="setup-screen" style="display: none;">
        <div class="setup-card">
            <h1>üîê Setup</h1>
            <p>Bitte Zugangsdaten eingeben, um fortzufahren.</p>
            <label for="nameInput">Dein Name</label>
            <input type="text" id="nameInput" placeholder="z.B. Carsten">
            <p class="hint">Wird bei Freigaben als "Gepr√ºft von" gespeichert.</p>
            <label for="tokenInput">Airtable Personal Access Token</label>
            <input type="password" id="tokenInput" placeholder="pat...">
            <p class="hint">Token wird lokal im Browser gespeichert.</p>
            <button onclick="saveSetup()">Verbinden</button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Lade Produktdaten...</p>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-left">
                <h1>üîç Produkttext Review</h1>
                <div class="product-info">
                    <span class="product-name" id="productName">-</span>
                    <span class="product-sku" id="productSku">-</span>
                    <span class="ampel" id="ampelBadge">-</span>
                </div>
            </div>
            <div class="header-right">
                <span class="queue-info"><span id="currentIndex">-</span> von <span id="totalCount">-</span></span>
                <button class="nav-btn" onclick="navigatePrev()" id="prevBtn">‚Üê Zur√ºck</button>
                <button class="nav-btn" onclick="navigateNext()" id="nextBtn">Weiter ‚Üí</button>
            </div>
        </header>
        
        <div class="main-container">
            <!-- Left Panel: Old Text -->
            <div class="panel">
                <div class="panel-header">
                    <span>Alter Text</span>
                    <span id="oldTextLength">0 Zeichen</span>
                </div>
                <div class="panel-content">
                    <div class="old-text-content" id="oldTextContent"></div>
                </div>
            </div>
            
            <!-- Middle Panel: New Text Preview -->
            <div class="panel preview-panel">
                <div class="panel-header">
                    <span>Neuer Text (Live-Preview)</span>
                    <div class="device-toggle">
                        <button class="active" onclick="setDevice('desktop', this)">Desktop</button>
                        <button onclick="setDevice('tablet', this)">Tablet</button>
                        <button onclick="setDevice('mobile', this)">Mobile</button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="preview-frame desktop" id="previewFrame">
                        <div class="preview-content" id="previewContent">
                            <p style="color: #999; text-align: center;">Kein neuer Text vorhanden</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Compliance Protocol -->
            <div class="panel">
                <div class="panel-header">
                    <span>Compliance-Protokoll</span>
                </div>
                <div class="panel-content" id="protocolContent">
                    <p style="color: #999;">Kein Protokoll vorhanden</p>
                </div>
            </div>
        </div>
        
        <!-- Action Bar -->
        <div class="action-bar">
            <div class="action-buttons">
                <button class="action-btn approve" onclick="setStatus('Freigegeben')" id="approveBtn">
                    ‚úì Freigeben
                </button>
                <button class="action-btn revise" onclick="setStatus('√úberarbeiten')" id="reviseBtn">
                    ‚Üª √úberarbeiten
                </button>
            </div>
            <div class="comment-section">
                <input type="text" id="commentInput" placeholder="Kommentar (optional)...">
                <div class="reviewer-display" id="reviewerDisplay" style="padding:10px 14px;background:#f5f5f5;border-radius:6px;font-size:14px;color:#666;">
                    Pr√ºfer: <strong id="reviewerNameDisplay">-</strong>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const AIRTABLE_BASE_ID = 'appwfr6TDvdfTpLOb';
        const AIRTABLE_TABLE_ID = 'tblxh8JKmGzkNe2aN';
        
        // Field IDs from table creation
        const FIELDS = {
            produkt: 'fldCGIR2aUFW0kHyX',
            produktnummer: 'fldwlggbloAkJ3TJu',
            shopwareId: 'fldErX95xiQ1ywZjm',
            status: 'fldbGwXkocpqJerzH',
            ampel: 'fldrXDNVzuumVVGJa',
            alterText: 'fldhjX8wFuM9yI3IH',
            neuerText: 'fldYOrXPl8jIr1uJV',
            complianceProtokoll: 'fldlxI9afHwF52kgY',
            metaTitle: 'fld9PCzyr5DJL05vI',
            metaDescription: 'fldxopIzwycZUSunB',
            keywords: 'fldWQh578WKppK9Hm',
            shortDescription: 'fldynyKRUgdDfZg5G',
            seoStatus: 'fldVNwptTisLJmfKX',
            prueferKommentar: 'fldhx3UnPtJHAI2vN',
            geprueftVon: 'fldzcLHQwBlIjr66x'
        };
        
        // ============================================
        // STATE
        // ============================================
        
        let token = localStorage.getItem('airtable_token');
        let reviewerName = localStorage.getItem('reviewer_name');
        let currentRecord = null;
        let recordQueue = [];
        let currentQueueIndex = 0;
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            if (!token || !reviewerName) {
                document.getElementById('setupScreen').style.display = 'flex';
                // Falls einer der Werte existiert, vorausf√ºllen
                if (reviewerName) document.getElementById('nameInput').value = reviewerName;
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const recordId = urlParams.get('id');
            
            if (recordId) {
                // Direct link to specific record
                await loadRecord(recordId);
            } else {
                // Load queue of records to review
                await loadQueue();
            }
        }
        
        function saveSetup() {
            const inputName = document.getElementById('nameInput').value.trim();
            const inputToken = document.getElementById('tokenInput').value.trim();
            
            if (!inputName) {
                alert('Bitte Namen eingeben!');
                return;
            }
            if (!inputToken) {
                alert('Bitte Token eingeben!');
                return;
            }
            
            localStorage.setItem('reviewer_name', inputName);
            localStorage.setItem('airtable_token', inputToken);
            reviewerName = inputName;
            token = inputToken;
            document.getElementById('setupScreen').style.display = 'none';
            init();
        }
        
        // ============================================
        // AIRTABLE API
        // ============================================
        
        async function airtableFetch(endpoint, options = {}) {
            const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                throw new Error(`Airtable API Error: ${response.status}`);
            }
            
            return response.json();
        }
        
        async function loadQueue() {
            showLoading(true);
            
            try {
                // Load records with status "Zur Pr√ºfung"
                const data = await airtableFetch(
                    `${AIRTABLE_TABLE_ID}?filterByFormula={Status}="Zur Pr√ºfung"&sort[0][field]=Ampel&sort[0][direction]=desc`
                );
                
                recordQueue = data.records || [];
                
                if (recordQueue.length === 0) {
                    showAllDone();
                    return;
                }
                
                currentQueueIndex = 0;
                await displayRecord(recordQueue[0]);
                updateQueueNavigation();
                
            } catch (error) {
                showError('Fehler beim Laden: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadRecord(recordId) {
            showLoading(true);
            
            try {
                const data = await airtableFetch(`${AIRTABLE_TABLE_ID}/${recordId}`);
                currentRecord = data;
                recordQueue = [data];
                currentQueueIndex = 0;
                await displayRecord(data);
                updateQueueNavigation();
                
            } catch (error) {
                showError('Fehler beim Laden: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function updateRecord(recordId, fields) {
            return airtableFetch(`${AIRTABLE_TABLE_ID}/${recordId}`, {
                method: 'PATCH',
                body: JSON.stringify({ fields })
            });
        }
        
        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================
        
        async function displayRecord(record) {
            currentRecord = record;
            const fields = record.fields;
            
            document.getElementById('mainApp').style.display = 'block';
            
            // Header
            document.getElementById('productName').textContent = fields['Produkt'] || '-';
            document.getElementById('productSku').textContent = fields['Produktnummer'] || '-';
            
            const ampelBadge = document.getElementById('ampelBadge');
            const ampel = fields['Ampel'] || 'GR√úN';
            ampelBadge.textContent = ampel;
            ampelBadge.className = 'ampel ' + ampel;
            
            // Old Text - als HTML rendern
            const oldText = fields['Alter Text'] || '';
            document.getElementById('oldTextContent').innerHTML = oldText || '<p style="color:#999;font-style:italic;">Kein alter Text vorhanden</p>';
            document.getElementById('oldTextLength').textContent = oldText.length + ' Zeichen';
            
            // New Text Preview
            const newText = fields['Neuer Text'] || '';
            document.getElementById('previewContent').innerHTML = newText || '<p style="color:#999;text-align:center;">Kein neuer Text</p>';
            
            // Compliance Protocol
            renderProtocol(fields);
            
            // Load existing comment
            document.getElementById('commentInput').value = fields['Pr√ºfer-Kommentar'] || '';
            
            // Show reviewer name
            document.getElementById('reviewerNameDisplay').textContent = reviewerName || '-';
        }
        
        function renderProtocol(fields) {
            const container = document.getElementById('protocolContent');
            let protokoll = fields['Compliance-Protokoll'] || '';
            const ampel = fields['Ampel'] || 'GR√úN';
            
            // Try to parse as JSON (might be double-stringified from n8n)
            let protocolData = null;
            try {
                // First attempt
                protocolData = JSON.parse(protokoll);
                
                // If it's still a string, parse again (double-encoded)
                if (typeof protocolData === 'string') {
                    protocolData = JSON.parse(protocolData);
                }
            } catch (e) {
                // Not JSON, display as text
                console.log('Protocol parse error:', e);
            }
            
            if (protocolData && typeof protocolData === 'object') {
                container.innerHTML = renderProtocolJSON(protocolData, fields);
            } else if (protokoll) {
                container.innerHTML = `<div class="protocol-item">${protokoll.replace(/\n/g, '<br>')}</div>`;
            } else {
                // Generate basic protocol from available data
                container.innerHTML = renderBasicProtocol(fields, ampel);
            }
        }
        
        function renderProtocolJSON(data, fields) {
            let html = '';
            
            // Summary
            html += `
                <div class="protocol-section">
                    <div class="protocol-section-title">
                        <span class="status-icon">${data.ampel === 'GR√úN' ? '‚úÖ' : data.ampel === 'GELB' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                        Zusammenfassung
                    </div>
                    <div class="protocol-item ${data.ampel === 'GR√úN' ? 'success' : data.ampel === 'GELB' ? 'warning' : 'error'}">
                        <strong>${data.recommendation || 'Keine Empfehlung'}</strong><br>
                        ${data.summary || ''}
                    </div>
                </div>
            `;
            
            // EFSA Claims
            if (data.efsa && data.efsa.claimsUsed) {
                html += `
                    <div class="protocol-section">
                        <div class="protocol-section-title">
                            <span class="status-icon">${data.efsa.status === 'OK' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            EFSA-Claims
                        </div>
                        <div class="claim-list">
                            ${data.efsa.claimsUsed.map(c => `
                                <div class="claim-item">
                                    <span class="claim-status">${c.valid ? '‚úì' : '‚úó'}</span>
                                    <span><strong>${c.ingredient}:</strong> ${c.claim}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // SEO
            if (data.seo) {
                html += `
                    <div class="protocol-section">
                        <div class="protocol-section-title">SEO-Check</div>
                        <div class="seo-grid">
                            <div class="seo-item">
                                <span class="label">Meta-Title</span>
                                <span class="value ${data.seo.metaTitleOk ? 'ok' : 'warning'}">${data.seo.metaTitleLength || '?'}/60</span>
                            </div>
                            <div class="seo-item">
                                <span class="label">Meta-Desc</span>
                                <span class="value ${data.seo.metaDescOk ? 'ok' : 'warning'}">${data.seo.metaDescLength || '?'}/155</span>
                            </div>
                            <div class="seo-item">
                                <span class="label">Keywords</span>
                                <span class="value ${data.seo.keywordsOk ? 'ok' : 'warning'}">${data.seo.keywordCount || '?'} St√ºck</span>
                            </div>
                            <div class="seo-item">
                                <span class="label">Short-Desc</span>
                                <span class="value ${data.seo.shortDescOk ? 'ok' : 'warning'}">${data.seo.shortDescLength || '?'}/160</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // FAQs
            if (data.faq && data.faq.length > 0) {
                html += `
                    <div class="protocol-section">
                        <div class="protocol-section-title">H√§ufige Einw√§nde</div>
                        ${data.faq.map(f => `
                            <div class="faq-item">
                                <div class="faq-question">‚ùì ${f.question}</div>
                                <div class="faq-answer">${f.answer}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }
        
        function renderBasicProtocol(fields, ampel) {
            const metaTitle = fields['Meta-Title'] || '';
            const metaDesc = fields['Meta-Description'] || '';
            const keywords = fields['Keywords'] || '';
            const shortDesc = fields['Short-Description'] || '';
            
            return `
                <div class="protocol-section">
                    <div class="protocol-section-title">
                        <span class="status-icon">${ampel === 'GR√úN' ? '‚úÖ' : ampel === 'GELB' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                        Status: ${ampel}
                    </div>
                </div>
                
                <div class="protocol-section">
                    <div class="protocol-section-title">SEO-Daten</div>
                    <div class="seo-grid">
                        <div class="seo-item">
                            <span class="label">Meta-Title</span>
                            <span class="value ${metaTitle.length <= 60 ? 'ok' : 'warning'}">${metaTitle.length}/60</span>
                        </div>
                        <div class="seo-item">
                            <span class="label">Meta-Desc</span>
                            <span class="value ${metaDesc.length <= 155 ? 'ok' : 'warning'}">${metaDesc.length}/155</span>
                        </div>
                        <div class="seo-item">
                            <span class="label">Keywords</span>
                            <span class="value">${keywords.split(',').filter(k => k.trim()).length} St√ºck</span>
                        </div>
                        <div class="seo-item">
                            <span class="label">Short-Desc</span>
                            <span class="value ${shortDesc.length <= 160 ? 'ok' : 'warning'}">${shortDesc.length}/160</span>
                        </div>
                    </div>
                </div>
                
                ${metaTitle ? `
                <div class="protocol-section">
                    <div class="protocol-section-title">Meta-Title</div>
                    <div class="protocol-item">${metaTitle}</div>
                </div>
                ` : ''}
                
                ${metaDesc ? `
                <div class="protocol-section">
                    <div class="protocol-section-title">Meta-Description</div>
                    <div class="protocol-item">${metaDesc}</div>
                </div>
                ` : ''}
            `;
        }
        
        // ============================================
        // ACTIONS
        // ============================================
        
        async function setStatus(status) {
            if (!currentRecord) return;
            
            const comment = document.getElementById('commentInput').value.trim();
            
            if (!reviewerName) {
                showToast('Kein Pr√ºfer-Name gespeichert!', 'error');
                return;
            }
            
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            try {
                await updateRecord(currentRecord.id, {
                    'Status': status,
                    'Pr√ºfer-Kommentar': comment,
                    'Gepr√ºft von': reviewerName
                });
                
                showToast(`Status auf "${status}" gesetzt!`, 'success');
                
                // Remove from queue and go to next
                recordQueue.splice(currentQueueIndex, 1);
                
                if (recordQueue.length === 0) {
                    showAllDone();
                    return;
                } else {
                    if (currentQueueIndex >= recordQueue.length) {
                        currentQueueIndex = recordQueue.length - 1;
                    }
                    await displayRecord(recordQueue[currentQueueIndex]);
                    updateQueueNavigation();
                }
                
            } catch (error) {
                showToast('Fehler: ' + error.message, 'error');
            } finally {
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        
        function updateQueueNavigation() {
            document.getElementById('currentIndex').textContent = currentQueueIndex + 1;
            document.getElementById('totalCount').textContent = recordQueue.length;
            document.getElementById('prevBtn').disabled = currentQueueIndex === 0;
            document.getElementById('nextBtn').disabled = currentQueueIndex >= recordQueue.length - 1;
        }
        
        async function navigatePrev() {
            if (currentQueueIndex > 0) {
                currentQueueIndex--;
                await displayRecord(recordQueue[currentQueueIndex]);
                updateQueueNavigation();
            }
        }
        
        async function navigateNext() {
            if (currentQueueIndex < recordQueue.length - 1) {
                currentQueueIndex++;
                await displayRecord(recordQueue[currentQueueIndex]);
                updateQueueNavigation();
            }
        }
        
        // ============================================
        // UI HELPERS
        // ============================================
        
        function setDevice(device, btn) {
            document.getElementById('previewFrame').className = 'preview-frame ' + device;
            document.querySelectorAll('.device-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showError(message) {
            document.getElementById('mainApp').innerHTML = `
                <div class="error-state">
                    <h2>‚ö†Ô∏è Fehler</h2>
                    <p>${message}</p>
                    <button onclick="window.location.reload()" style="margin-top:20px;padding:10px 20px;cursor:pointer;">
                        Neu laden
                    </button>
                </div>
            `;
            document.getElementById('mainApp').style.display = 'block';
        }
        
        function showAllDone() {
            document.getElementById('mainApp').innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);color:#fff;text-align:center;padding:40px;">
                    <p style="font-size:1.3em;color:#888;margin-bottom:30px;">Keine Produkte zur Pr√ºfung vorhanden.</p>
                    <button onclick="window.location.reload()" style="background:#a0ba32;color:#fff;border:none;padding:14px 28px;border-radius:8px;font-size:16px;cursor:pointer;transition:all 0.2s;">
                        üîÑ Auf neue Produkte pr√ºfen
                    </button>
                </div>
            `;
            document.getElementById('mainApp').style.display = 'block';
        }
        
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ============================================
        // START
        // ============================================
        
        init();
    </script>
</body>
</html>
